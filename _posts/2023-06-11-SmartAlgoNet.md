---
layout: post
title: "Скрипт SmartAlgoNet"
author: "nnh"
description: Скрипт SmartAlgoNet.
tags: [скрипт,lua,qlua,квик,quik,сеточник,SmartAlgoNet]
---

Скрипт позволяет установить сетку ордеров на вход (выход) в позицию. Работает как с фондовой, так и на срочной, валютной секциях. Скрипт написан на языке LUA. Среда исполнения - торговый терминал Quik.


[Видео настроек, работы скрипта](https://youtube.com/playlist?list=PLJBphc0sVfGaj1jEAmehHgAVXgkH-tO7h)

##	Основные возможности скрипта

Установка сетки ордеров на вход и выход. Динамическая сетка, алгоритмический шаг уровней. Стоп-лосс, контроль прибыли. Оповещения. Журнал сделок.

Скрипт отслеживает установленное соединение с сервером брокера, время торговой сессии по инструменту, исключая подачи команд на сервер брокера в периоды отсутствия соединения с сервером брокера, неторговое время (клиринг, окончание торговой сессии). После восстановления соединения с сервером брокера происходит проверка полученных пакетов (если включена такая настройка), дабы избежать запуска алгоритма на неполных данных.
Скрипт корректно отрабатывает закрытие торгового терминал без остановки скрипта. После перезапуска терминала скрипт автоматически запустится, перейдет в период ожидания подключения к серверу брокера, загрузки всех информационных пакетов с сервера брокера.

Для каждого запуска формируется файл лога в каталоге /logs. Если в процессе работы скрипта возникнут ошибки, то будет дополнительно сформирован файл лога ошибок. Если ошибок будет слишком много, то скрипт принудительно остановится.

##	Основное окно скрипта.

![](/assets/images/net/mainW.PNG)

Главное окно содержит колонки вывода и управления информацией:
 - [...] - Колонка управления строкой. Если строка пустая, то нажатие на данную команду выведет окно выбора инструмента. Если строка уже заполнена, то в данной колонке будет выведена команда удаления строки “Del”.
 - state – в данной колонке отображается состояние строки торгуемого инструмента: “Run” - запущен; “Stop” - остановлен
 - sec_code - в данной колонке отображается краткое наименование торгуемого инструмента
 - "+/-" - в данной колонке отображается команда вызова окна калькулятора по торгуемому инструменту
 - account - в данной колонке отображается наименование выбранного счета и субсчета (код клиента) на котором осуществляется торговля
 - Set - в данной колонке отображается команда вызова окна настройки параметров торгуемого инструмента
 - Price - в данной колонке отображается информация о цене последней сделки по инструменту
 - Position - в данной колонке отображается текущей позиции по торгуемому инструменту на указанном счете/субсчете
 - Profit - в данной колонке отображается текущая накопленная прибыль (по закрытым уровням) по инструменту. Также по двойному нажатию по колонке открывается окно сохраненных сделок, если включен журнал сделок.
 - Close - команда на закрытие открытой позиции
 - xNet- команда на закрытие установленной сетки
 - bNet- команда на установку сетки на покупку
 - sNet - команда на установку сетки на продажу
 - SL TP - в данной колонке отображается текущая информация по установленному стоп-лоссу
 - virtual - включение|выключение режима виртуальной торговли
 - robot_mode - выбор направления активации сетки алгоритмом
 - ALGO - в данной колонке отображается информация алгоритма отслеживания прибыли
 - trade_qty - торговый объем. Количество лот.
 - initial_net_trade_qty - Первоначальный торговый объем сетки
 - net_trade_start_price - цена начала построения сетки
 - stop_loss - в данной колонке отображается информация по указанному параметру значения, устанавливаемого стоп-лосса. Здесь же можно быстро произвести изменения значения, не открывая окно настроек.
 - Message - в данной колонке отображается последнее информационное сообщение по торгуемому инструменту.

Дополнительное окно состояния сетки содержит поля:
 - active - Состояние уровня. Можно переключать состояние, тем самым временно снимать ордер открытия уровня.
 - block - состояние автоматической блокировки уровня (вне начального торгового объема), ручной блокировки.
 - sl_block - состояние блокировки уровня за стоп-ордером.
 - dir - направление текущего уровня.
 - qty - количество.
 - price - цена открытия уровня.
 - dyn_open - динамический уровень открытия (если выбран режим динамической сетки).
 - o_state - состояние ордера открытия.
 - close - цена закрытия уровня.
 - delta - дельта в пунктах между ценой открытия и закрытия
 - dyn_close - динамический уровень закрытия (если выбран режим динамической сетки).
 - close_type - текущий тип шага закрытия уровня
 - close_step - значение шага закрытия уровня
 - c_count - число итераций закрытия уровня.
 - profit - накопленный профит на уровне.


##	Окно настроек скрипта.
Для настройки торговых параметров по инструменту необходимо выполнить команду “[...]” в поле “Set”. В результате будет показана форма настроек.

![](/assets/images/net/settings.PNG)

Большинство параметров содержат описание. Его можно вызвать по кнопке "?".

![](/assets/images/net/field_description.PNG)


### Раздел “ОБЩИЕ НАСТРОЙКИ” содержит настройки:

 - Идентификатор скрипта - комментарий, добавляемый к транзакциям. По нему можно будет определить ордера и сделки, совершенные скриптом. Идентификатор должен быть уникальным среди всех скриптов и строк скрипта. При этом необходимо обеспечить уникальность "по вхождению". Для примера идентификаторы str и str1 не уникальные, т.к. первый входит во второй. А str0 и str1 уже уникальные. Не допускается использовать символы ( ) . % + - * ? [ ^ $
 - Запустить при запуске - автоматический запуск строк скрипта при запуске.
 - Время автозапуска - конкретное время для автозапуска. Указывается как строка вида ЧЧ:ММ:СС. Либо ЧЧ:ММ. Если указано, то настройка "Запустить при автозапуске" не работает.
 - Время автоостановки - время остановки сроки скрипта. Указывается как строка вида ЧЧ:ММ:СС. Либо ЧЧ:ММ.
 - Закрывать позицию|снимать сетку при автоостановке
 - Заменять инструмент на следующий за указанное число дней до экспирации. Важно: происходит только замена инструмента в строке скрипта. Позиция и уже выставленные ордера при этом не затрагиваются.
 - Идентификатор графика куда будут выводиться метки сделок в виртуальном режиме работы. Также метки скрытых стоп-ордеров. Задается в разделе "Дополнительно" свойств цены графика.
 - Выводить метку позиции - если заполнен Идентификатор графика, то можно вывести метку средней цены позиции. Отправлять сообщения в Телеграм.
 - Отправлять сообщения E-Mail.
 - Выводить метку позиции - если включено, то будет выводится метка средней цены открытой позиции.
 - Калькулятор инструмента - команда открытия окна калькулятора по инструменту.
 -  Команда "Настроить позицию" - Настроить позицию: Необходимо заполнить (отредактировать) уровни входа текущей позиции. Это может понадобится в тех случаях, когда скрипт не смог корректно рассчитать средную цену входа текущей позиции.

#### Окно формы редактирования позиции:

![](/assets/images/net/pos_settings.PNG)

Открытая позиция - это одна или несколько сделок в указанных количестве и цене. Исходя из введенных данных рассчитывается среднняя, объем позиции.  В процессе работы данные о позиции рассчитываются автоматически, но т.к. скрипт не учитывает сделки, совершенные минуя команды скрипта (т.е. руками через терминал, другими скриптами), то может возникнуть ситуация когда текущая реальная позиция не соответствует той, что помнит скрипт. Или это возможно, когда скрипт был запущен когда позиция уже была сформирована, а сделки (или их часть) отстутствуют в терминале. Допустим, сделки были несколько торговых сессий назад.


### Раздел “ТОРГОВЫЕ НАСТРОЙКИ” содержит настройки:

 - ВИРУТАЛЬНАЯ ТОРГОВЛЯ - режим эмуляции торговли. В этом режиме все команды из основного окна скрипта не будут приводить к совершению реальных сделок. Вместо этого сделки будут совершаться "в памяти". Также будут выводиться метки совершенных сделок на график, если заполнен параметр "Идентификатор графика". Стоп ордера также будут скрытыми. Этот режим будет полезен для проверки торговых идей в условиях максимально приближенных к реальным.
 - РЕЖИМ РОБОТА. Выбор направления активации сетки алгоритмом. Возможные значения:
   - ЛОНГ | ШОРТ
   - ЛОНГ
   - ШОРТ
 - Торговый объем - полный торговый размер(объем) сетки. Данная настройка также выведена в главное окно скрипта, для быстрого изменения значения. Данный параметр можно изменять в большую сторону уже при установленной сетки. Уровни будут установливаться по мере исполнения уровней сетки.
 - Первоначальный торговый объем сетки - торговый объем первоначального построения сетки. При активации сетки будут сразу установены уровни на этот объем. Остаток до полного торгового объема будет установлен по мере исполнения уровней сетки. Если задно 0, то не учитывается и сетка сразу устанавливается на полный торговый объем. Т.о. часть уровней будут активны, а остальные будут заблокированы. По мере исполнения уровней они будут разблокироваться.
 - Отступ заявки по рынку - при подаче заявки по рынку необходимо указать цену, сдвинутую на число шагов от текущей, чтобы она гарантировано исполнилась. Данный параметр важен при торговле на срочном рынке, т.к. от цены заявки зависит расчет ГО. Также в моменты высокой волатильности данный параметр позволит отрегулировать отступ для рыночной заявки.
 - Проверять лимиты - при подаче заявки проверить доступность денежных средств.
 - Проверять лимиты цен - при подаче заявки проверить что цена заявки в допустимом диапазоне цен.
 - Ожидание при сдвиге ордера (сек.) - если установлен стоп-ордер и пользователь сдвинул его на графике на новый ценовой уровень, то скрипт ждет его появления, прежде чем перевыставить новый ордер. Если пользователь просто случайно (по ошибке) снял его, то скрипт через указанной время выставит заново стоп ордер.
 - Ожидание сигнала после ошибки (сек.) - Период ожидания (в сек.) обработки нового торгового сигнала в случае прошлой неудачной попытки. Если при обработке торгового сигнала была ошибка (недостаточно средств, отвергнутая заявка и т.д.), то следующий сигнал того же характера будет отработан по истечении периода ожидания
 - Забыть открытую позицию - данная команда очищает позицию, запомненную скриптом (ВАЖНО. Не закрывает физически, а очищает из памяти). Например, Скрипт открыл позицию, выставил стоп-ордер.  Далее скрипт был выключен, позиция была закрыта руками, сработал стоп при выключенном скрипте и т.д. Т.е. произошло изменение позиции, которое скрипт не контролировал, т.е. скрипт не узнает об этом. В этом случае можно выполнить команду и скрипт забудет информацию по ранее открытой позиции и можно запустить скрипт заново.


### Раздел "СТУПЕНИ ВХОДА"

 - Активиция|Разворот сетки уровней алгоритмом - Режим активации сетки по событиям алгоритма. Если выключено, то сетка ордеров не будет устанавливаться автоматически по сигналам, но можно устанавливать или снимать ручными командами. Виды алгоритмов активации:
   - "MA" для варианта алгоритма Тренд: Если значение MA на закрытом баре больше чем значение MA на предыдущем баре, то происходит активация сетки в ЛОНГ. Для ШОРТ наоборот.
   -  "MA" для варианта алгоритма Касание:  не лучше средней. Если очередной бар закрывается за MA (Для ЛОНГ - вниз, для ШОРТ - вверх), то происходит активация сетки. Данный режим доступен для режимов торговли "ЛОНГ" и "ШОРТ".
   - "MACD" -  если MACD последнего закрытого бара пересекает 0, то происходит активация сетки.
   - "PSAR" -  если Parabolic SAR последнего закрытого бара меняет направление, то происходит активация сетки.
   - "RSI" -  если RSI последнего закрытого бара пересекает уровень, то происходит активация сетки. Вариант условия выбирается:
     - Cross DW - Пересечение уровня вниз
     - Cross UP - Пересечение уровня вверх
   - "STOCH" -  если Стохастик последнего закрытого бара пересекает уровень, то происходит активация сетки. Вариант условия выбирается:
     - Cross DW - Пересечение уровня вниз
     - Cross UP - Пересечение уровня вверх
   - "BOL" -  если бар закрывается за каналом Боллинджера, то происходит активация сетки в направлении пробитя.
   - "REG" для варианта алгоритма Тренд: если регрессия меняет направление, то происходит активация сетки.
   - "REG" для варианта алгоритма Пробой: если бар закрывается за каналом регрессии, то происходит активация сетки в направлении пробития.
   - "KREG" -  рассчитывается Ядерная регрессия Надарая — Уотсона. Если бар закрывается за каналом Ядерной регрессии, то происходит активация сетки в направлении пробития.
   - "MA+ATR" -  рассчитывается канал вокруг MA +/- k*ATR (канал Кельтнера). Если бар закрывается за каналом, то происходит активация сетки в направлении пробития.

 - "Настроить алгоритм активации" - команда для открытия окна настроек выбранного алгоритма активации сетки

------------------------------------------------------------------------------------------------------------------------------------------------
  Пример окна настроек активации сетки алгоритмом PSAR

  ![](/assets/images/net/algo_net_settings.PNG)

  В данной форме необходимо указать интервал баров (свечей) для расчета алгоритма, параметры расчета выбранного алгоритма.
  - Всегда снимать(разворачивать) активную сетку при смене направления сигнала алгоритма - При смене направления сигнала алгоритма всегда снимать(разворачивать) активную сетку. Возможные значения:
    - OFF - выключено. Сигнал игнорируется. Активная сетка может быть снята руками или исполнена. Т.к. сигнал игнорируется, то открытая позиция также не будет изменена.
    - ON  - включено. При смене направления всегда снимать(разворачивать) активную сетку (также происходит закрытие позиции). Переворот осуществляется если новое направление разрешено в настройке "ТОРГОВЫЕ НАСТРОЙКИ:РЕЖИМ РОБОТА"
  - Всегда закрывать позицию при смене направления сигнала алгоритма - При смене направления сигнала алгоритма всегда закрывать(переворачивать) позицию.
    - OFF - выключено. Позиция закроется по стоп-профиту или руками.
    - ON  - включено. При смене направления всегда закрывать(переворачивать) позицию. Переворот осуществляется если новое направление разрешено в настройке "ТОРГОВЫЕ НАСТРОЙКИ:РЕЖИМ РОБОТА" и разрешен разворот сетки.
------------------------------------------------------------------------------------------------------------------------------------------------

 - Алгоритм динамических уровней сетки - В данном режиме происходит расчет канала по выбранному алгоритму. Его ширина и одна из границ (для ЛОНГА - нижняя, для ШОРТА - верхняя) - это база расчета. Для ЛОНГА уровень задается как 30% (значение не ограничено, можно вводить и отрицательные значения и значения больше 100) ширины от нижней границы. Т.о. по мере изменения канала будут смещаться ордера и уровни на новую расчетную точку = 30% от ширины. Для ШОРТ, наоборот, от верхней границы. В данном режиме уровни заполняются не в ценах инструмента а в процентах от ширины канала. Виды алгоритмов динамической сетки:
   - "BOL" -  рассчитывается канал Боллинджера. Уровни рассчитываются по границам канала.
   - "MA+ATR" -  рассчитывается канал вокруг MA +/- k*ATR (канал Кельтнера). Уровни рассчитываются по границам канала.
   - "REG" -  рассчитывается регрессионный канал. Уровни рассчитываются по границам канала.
   - "KREG" -  рассчитывается Ядерная регрессия Надарая — Уотсона. Уровни рассчитываются по границам канала.
   - "Настроить алгоритм динамической сетки" - команда вызова окна настройки алгоритма динамической сетки

------------------------------------------------------------------------------------------------------------------------------------------------
Пример окна настройки динамических уровней:

  ![](/assets/images/net/dyn_net_settings.PNG)

   - Интервал расчета динамической сетки - Интервал баров алгоритма активации для расчета событий.
   - Рассчитывать баров истории - Интервал баров алгоритма активации, для расчета событий.
   -  Активировать построение сетки по уровню - Если включен режим алгоритмической активации сетки, то включение данного режима, позволит заполнять сетку только после достижения ценой заданного уровня активации. Т.о. если произошло изменение тренда, но при этом цена не достигла уровня активации, сетка не будет заполнена. Это позволит избежать построений сетки при ложных, неподтвержденных сигналах. Для ручных команд данная настройка не контролируется, т.е. командами можно установить сетку при любом положении цены. Уровень активации динамической сетки выражен в % о ширины канала. Уровень отсчитывается от нижней границы канала для направления ЛОНГ, верхней для направления ШОРТ. Достижение уровня это нахождение ценой выше уровня для направления ЛОНГ, ниже для направления ШОРТ.
   - Уровень активации ( % от ширины канала) - Если включен параметр "Активировать построение сетки по уровню". Уровень активации динамической сетки выраженный в % от ширины канала. Уровень отсчитывается от нижней границы канала для направления ЛОНГ, верхней для направления ШОРТ. Достижение уровня это нахождение ценой выше уровня для направления ЛОНГ, ниже для направления ШОРТ.
   - Тип цены контроля ширины канала - Тип цены контроля ширины канала. Возможные значения:
     - % (процент) - процент.
     - Steps – шаги цены инструмента.
     - Pips - пункты цены инструмента.
   - Минимальная ширина канала для активации - Если включен режим алгоритмической активации сетки, то можно указать минимальную ширину канала для автоматической активации сетки. Т.о. если произошло изменение тренда, но при этом ширина канала меньше минимальной, сетка не будет заполнена. Эт позволит избежать построений сетки при слишком низкой волатильности. Значение 0 означает, что не данный параметр не контролируется. Для ручных команд данная настройка не контролируется, т.е. командами можно установить сетку при любой ширине.
   - Максимальная ширина канала для активации - Если включен режим алгоритмической активации сетки, то можно указать максимальную ширину канала, больше которой блокируется автоматическая активация сетки. Т.о. если произошло изменение тренда, но при этом ширина канала больше максимальной сетка не будет заполнена. Это позволит избежать построений сетки при слишком высокой волатильности. Значение 0 означает, что не данный параметр не контролируется. Для ручных команд данная настройка не контролируется, т.е. командами можно установить сетку при любой ширине.
   - Фиксировать цену начала построения сетки - Если задано фиксировать цену начала построения сетки, то первый уровень всегда будет рассчитан как % от ширины канала.
   -  % range начала построения сетки - Если задано фиксировать цену начала построения сетки, то первый уровень всегда будет рассчитан как % от ширины канала. Параметр разрешено изменять при запущенном алгоритме. Изменение доступно через клавиши "стрелка влево" или "Стрелка вправо"
   - Тип цены контроля смещения уровня - Тип цены контроля смещения уровня. Возможные значения:
     - % (процент) - процент.
     - Steps – шаги цены инструмента.
     - Pips - пункты цены инструмента.
     - % dynamic range - процент ширины динамического канала.
   - Мин. смещение цены для сдвига уровня - Данная настройка позволяет указать минимальное движение цены для смещения уровня. Если в результате нового расчета динамического уровня, дельта смещения окажется ниже минимальной, то уровень не будет смещен. Это позволит минимизировать числ транзакций, исключая микросмещения уровней. Параметр разрешено изменять при запущенном алгоритме. Изменение доступно через клавиши "стрелка влево" или "Стрелка вправо"
   - Смещать закрытия уровней против сделки - Данная настройка позволит запретить смещение ордера закрытия уровня против сделки. Т.о. при смещении канала против сделки, уже установленные ордера закрытия останутся на своем уровне. Параметр разрешено изменять при запущенном алгоритме.
   - Не смещать закрытия уровней хуже уровня открытия - Если разрешено смещение ордера закрытия уровня против сделки, можно запретить смещение дальше его уровня открытия. Параметр разрешено изменять при запущенном алгоритме.

  В режиме динамических уровней по умолчанию тип цены закрытия задается как "% dynamic range". Но также доступны и базовые типы "Steps, %, Pips". В таком случае, при заполнении уровней, динамический шаг будет рассчитан исходя из заданной величины шага, т.е. обратный расчет. При работе сетки уже будут учитываться только динамические уровни.

  В данном режиме недоступен режим трейлинга уровней, режим алгоритмического шага закрытия уровней.

------------------------------------------------------------------------------------------------------------------------------------------------

 - Алгоритм расчета шага закрытия уровня -  В данном режиме рассчитывается текущая волатильность по выбранному алгоритму. Шаг закрытия уровней указывается как коэффициент от значения волатильности. Т.о. уровни входа указываются в виде конкретных цен, а уровни выхода будут рассчитываться динамически, в зависимости от рассчитанной волатильности. Данный режим недоступен если выбран режим Динамическая сетка. Возможные значения:
   - ATR - шаг закрытия уровня кратный ATR.
   - STD - шаг закрытия уровня кратный стандартному отклонению.
   - PRCICE RANGE - шаг закрытия уровня кратный ширине ценового канала.

 - Команда "Настроить алгоритмы шага закрытия уровней" - Если выбран алгоритмический шаг закрытия уровня, то необходимо указать параметры расчета алгоритма. Команда доступна при запущенном алгоритме.

------------------------------------------------------------------------------------------------------------------------------------------------

  Пример окна настройки алгоритмического шага закрытия уровня для алгоритма ATR:

  ![](/assets/images/net/algostep_settings.PNG)

 - Интервал алгоритма шага закрытия уровней - интервал баров алгоритма .
 - Тип цены контроля смещения уровня - Тип цены контроля смещения уровня. Возможные значения:
   - % (процент) - процент.
   - Steps – шаги цены инструмента.
   - Pips - пункты цены инструмента.
 - Мин. смещение цены для сдвига уровня - Данная настройка позволяет указать минимальное движение цены для смещения уровня. Если в результате нового расчета уровня закрытия, дельта смещения окажется ниже минимальной, то уровень не будет смещен. Это позволит минимизировать число транзакций, исключая микросмещения уровней.
------------------------------------------------------------------------------------------------------------------------------------------------

 - Выводить метки уровней - если заполнен Идентификатор графика, то можно вывести метки всех уровней.
 - Вид сетки уровней. Возможные значения:
   - Fix net - уровни с фиксированным шагом.
   - Distribution - уровни с расчетным шагом по заданной глубине и числу шагов.
   - Manual - преднастроенные уровни.
 - Тип ордера входа в позицию. Возможные значения:
   - Limit - вариант установки ордера с использованием заявки типа “Лимитный ордер”
   - Hidden - вариант установки ордера без физического выставления заявки на серверах брокера. По достижению уровня будет осуществлена сделка по рынку.
 - Тип цены шага уровней. Возможные значения:
   - % (процент) - процент
   - Steps – шаги цены инструмента
   - Pips - пункты цены инструмента
   - Currency - уровень задается в валюте цены инструмента, т.е. сама цена. Вариант "Currency" работает только для режима "Вид сетки уровней" = "Manual"
   - % dynamic range - процент ширины динамического канала. Если выбран режим Динамическая сетка.
 - Шаг сетки - Размер шага уровней в указанных единицах цены инструмента.
 - Коэфф. шага сетки - Коэффициент шага уровней. Каждый следующий шаг равен прошлому с учетом коэффициента. Для примера. Шаг уровней = 100. Коэффициент = 1.1. Первый шаг =100. Второй = 100 (первый) * 1.1 = 110. Третий = 110 (второй) * 1.1 = 121. И т.д. Коэффициент может быть < 1, тогда будет происходит сжатие размера шага.
 - Глубина сетки - Если задано 0, то глубина не ограничена. Для режима Вид сетки уровней = "Distribution" параметр является обязательным.
 - Число шагов сетки - Данный параметр используется для для режима Вид сетки уровней = "Distribution". Исходя из значения будет рассчитан шаг между уровнями.
 - Торговый объем шага сетки - Размер(объем) сделки на уровнях сетки
 - Цена начала построения сетки - Данная настройка используется если "Первый торговый объем по алгоритму" задан 0 и цена активации не задана алгоритмом входа (если подключен алгоритмический модуль входа в позицию). В этом случае цену начала построения сетки можно задать вручную. Если не задана цена алгоритма или не подключен алгоритмический модуль входа в позицию, то используется цена последней сделки.
 - Отступ начала построения сетки - Данная настройка используется если "Первый торговый объем по алгоритму" задан 0 и "Цена начала построения сетки" задана 0 (если подключен алгоритмический модуль входа в позицию). В этом случае первый уровень будет задан от цены активации (начала построения) с учетом отступа.
 - Снимать авто-добавленные уровни - если заполнен параметр "Первоначальный торговый объем сетки" меньше полного торгового объема, автоматически добавляются скрытые уровни до полного объема. По мере исполнения уровней, добавленные активируются. Если цена уйдет обратно, то можно указать чтобы активированные уровни были сняты. Т.о. будут разблокированы денежные средства.
 - Коэфф. торгового объема - Коэффициент торгового объема сетки. Каждый следующий равен прошлому с учетом коэффициента. Для примера. Торговый объем сетки = 1. Коэффициент = 2. Первый торговый объем сетки = 1. Второй = 1 (первый) * 2 = 2. Третий = 2 (второй) * 2 = 2. И т.д. Т.е. стратегия мартингейла с заданным коэффициентом. Коэффициент может быть < 1, тогда будет происходит уменьшение объема. Важно, объем будет округлять до 1, если расчетная величина станет меньше 1.
 - Настроить вручную ступени входа - Можно указать уровни входа в единицах, указанных в настройке "Тип цены шага уровней". Пример: Если необходимо указать два уровня в 75 и 100 шагов цены, то настройка "Тип цены шага уровней" имеет значение "Steps", а в строке вводим 75 в колонке "level". Для второй строки вводим 100. В колонке "qty" указывается объем, который относится к этому уровню. Если тип шага уровней это "% dynamic range", то значения - это проценты ширины динамического канала.

------------------------------------------------------------------------------------------------------------------------------------------------

Пример окна настроек уровней вручную в режиме "Manual".

  ![](/assets/images/net/manual_net.PNG)

Окно настроек уровней вручную в режиме Тип цены шага уровней равный Currency.

  ![](/assets/images/net/manual_net1.PNG)

В этом случае уровни - это конкретно заданная цена в валюте цены инструмента.

------------------------------------------------------------------------------------------------------------------------------------------------

 - Тип ордера закрытия уровней. Возможные значения:
 - Limit - вариант установки ордера с использованием заявки типа “Лимитный ордер”
 - Hidden - вариант установки ордера без физического выставления заявки на серверах брокера
 - Тип цены закрытия уровней. Возможные значения:
   - % (процент) - процент
   - Steps – шаги цены инструмента
   - Pips - пункты цены инструмента
   - Currency - уровень задается в валюте цены инструмента, т.е. сама цена. Вариант "Currency" работает только для режима "Вид сетки уровней" = "Manual"
   - % dynamic range - процент ширины динамического канала. Если выбран режим Динамическая сетка.
 - Шаг сетки закрытия позиции - Размер шага закрытия позиции в указанных единицах цены инструмента. Если не задан, то ордер устанавливается на вышестоящий уровень (т.е. используется основной шаг сетки).
 - Поддерживать размер шага закрытия при сдвиге ордера - при сдвиге ордера закрытия (открытия) уровня изменятся шаг между уровнем открытия и закрытия. При включенной настройке сдвиг ордера закрытия приведет к одновременному сдвигу и уровня открытия (закрытия). Т.о. шаг закрытия будет постоянным. Если настройка выключена, то будет изменен шаг закрытия, уровень открытия останется неизменным.
 - Число итераций закрытия уровней - Если установлен лимит, то ограничивается число циклов установки ордеров входа в позицию. По достижению лимита уровень деактивируется. Например, установив значение = 1, будут установлены ордера открытия позиции 1 раз. После их закрытия скрипт остановится. Т.о. реализуется режим, только закрытия позиции. Если лимит > 1, то после закрытия уровня, зеркальный ордер открытия будет установлен еще раз. И так, пока не будет достигнут лимит. Значение 0 - не ограничивать. Т.е. уровни будут восстанавливаться без ограничения.
 - Рассчитывать среднюю по активным уровням - Рассчитывать средний уровень позиции по активным уровням. Если включено, то средняя цена позиции рассчитывается по активным уровням. Для примера, открыты позиции на уровнях 1, 2 и 3. Закрыт уровень 3. Т.о. средняя цена будет рассчитана по уровням 1 и 2. Если выключено, то средняя цена позиции рассчитывается стандартным образом по принципу FIFO.
 - Для стоп-лосса: Уровень как средняя цена позиции - Принимать заданный уровень открытия позиции как среднюю цену позиции при установке стоп-лосса. Если задано значение -1, то устанавливать стоп от рассчитанной средней цены позиции. Если задано значение больше и равное числу рассчитанных уровней, то стоп будет установлен от последнего уровня.
 - Снимать уровни за стоп-ордером - При сдвиге стоп-ордера снимать ордера входа в позицию за стоп-ордером
 - Не устанавливать стоп-ордер при активной сетке - Если есть активные лимитные ордера входа, то можно не устанавливать стоп-ордер, чтобы избежать активации стоп-ордера одновременно с ордерами входа при сильном движении цены.
 - Редактирование активной сетки - команда, открывающая окно редактирования активной сетки.
 -  Включить безусловное снятие сетки - По достижению заданного уровня будет снята сетка (закрыта позиция). Уровень отсчитывается от первого уровня в момент первоначальной активации сетки.
 - Тип цены уровня безусловного снятия сетки - Тип цены уровня безусловного снятия сетки. Возможные значения:
  - * % (процент) - процент.
  - * Steps – шаги цены инструмента.
  - * Pips - пункты цены инструмента.
  - * Currency - уровень задается в валюте цены инструмента, т.е. сама цена.
 - Уровень безусловного снятия сетки

------------------------------------------------------------------------------------------------------------------------------------------------
  Примеры окон редактирования активной сетки:

  ![](/assets/images/net/edit_net_settings.PNG)

  ![](/assets/images/net/edit_net_settings1.PNG)

  В этом окне можно отредактировать количество, цены уровней, что приведет к перестановке ордера на уровне. В режиме динамической сетки задаются динамический уровни, а не конкретные цены. Также можно добавить новый уровень. Для нового уровня можно указать, что необходимо установить ордер закрытия, а не ордер открытия позиции.  Например, уже есть открытая позиция и надо часть уровней указать как уровни закрытия. При добавлении нового уровня по цене в середине диапазона сетки, произойдет сортировка уровней при запуске.
  Если указать параметр remove (удалить уровень), то такой уровень будет удален. Важно: удалить можно уровень, на котором нет активного ордера закрытия позиции и нет частичного исполнения ордера открытия.

------------------------------------------------------------------------------------------------------------------------------------------------

 - Не искать заявки с комментарием - скрипт автоматически ищет установленные заявки. Заявки с комментарием, содержащим введенное значение, будут игнорироваться
 - Не искать чужие заявки - Если данный режим выключен, то скрипт контролирует только свои заявки ступеней, с учетом введенного значения “Идентификатор скрипта”, который обязателен в этом режиме. В режиме "OFF" осуществляется поиск всех ордеров. Важно обеспечить уникальность параметра “Идентификатор скрипта”.

Режим Вида сетки уровней "Fix net" рассчитывает уровни с заданным шагом в параметре Шаг сетки с учетом Коэфф. шага сетки. Т.е. будут установлены ордера, пока не будет достигнут заданный объем входа в позицию или не будет достигнута глубина сетки, если она задана.

Режим Вида сетки уровней "Distribution" рассчитывает уровни от глубины и числа шагов сетки. Т.е. шаг сетки - это частное от деления глубины на число шагов. Если задан Коэфф. шага сетки, то расчет производится по формуле суммы геометрической последовательности.
Рассчитанный шаг округляется по правилам округления. После расчета шага производится расчет уровней сетки пока не будет достигнут торговый объем. В этом режиме важно соотносить число шагов сетки и торговый объем, т.к. может возникнуть ситуация, когда объем будет выбран раньше, чем достигнуто заданное число уровней.

### Раздел “СТУПЕНИ ВХОДА. ПРОФИТ-ТРЕЙЛ” содержит настройки:

В данном режиме контролируется уровень общей прибыли которая складывается из прибыли зафиксированных уровней и текущей прибыли открытых уровней. Если сформирован уровень отсечки прибыли, то при снижении прибыли ниже уровня отсечки, происходит закрытие текущей позиции и снятие активной сетки.

 - Включить профит-трейл - включить режим трейла профита.
 - Контрольное значение уровня прибыли - Контрольное значение уровня прибыли (в валюте цены). Как только уровень прибыли превысит контрольное значение, запускается таймер длительностью "Интервал контроля уровня прибыли" в течении которого контролируется текущий уровень прибыли относительно контрольного.
 - Интервал контроля уровня прибыли (мин.) - Временной интервал в течении, которого прибыль должна быть равно или больше контрольного значения. Если по окончании таймера уровень прибыли остается выше текущего контрольного значения, то уровень отсечки смещается на текущий уровень контроля.
 - Шаг трейла прибыли - Шаг трейла прибыли (в валюте цены). Если уровень прибыли превысил контрольное значения + шаг трейла, то контрольное значение поднимается на шаг трейла и устанавливается уровень отсечки на контрольное значение прибыли.

Пример: Задано контрольное значение прибыли 2000 руб. Интервал контроля 10 минут. Шаг прибыли 500 рублей.
Как только прибыль достигнет 2000 рублей активируется трейл и запускается таймер. Если в течении таймера прибыли так и останется выше 2000, то установится уровень фиксации прибыли 2000 рублей. Либо, если уровень прибыли поднимется 2000 + 500 = 2500 рублей, то установится уровень фиксации прибыли 2000 рублей. И так далее 3000 -> 2500, 3500 -> 3000 ...
Т.о. достижение очередного уровня прибыли сдвигает уровень фиксации. Либо, если прибыль держится выше текущего контрольного уровня прибыли дольше заданного временного интервал, то уровень фиксации также устанавливается на текущий контрольный уровень.

### Раздел “СТУПЕНИ ВХОДА. ВЫКУП” содержит настройки:

В данном режиме по команде "Установить сетку уровней" будет открыта позиция по рынку (или по конкретной цене) в объеме, заданном в параметре "Торговый объем шага объема выкупа". На этот объем будет установлена сетка ордеров закрытия позиции, а на остаток объема будет установлена основная сетка уровней. Т.о. будет сразу осуществлен вход на объем выкупа и установлены ордера выхода, а на остаток установлена основная сетка.

 - Команда "Распределить открытый объем по уровням" - если открыта текущая позиция, то можно распределить открытый объем по уровням по аналогии с первой рыночной сделкой. Весь открытый объем принимается за объем выкупа.
 - Включить выкуп - Включить реализацию первого торгового объема выкупа.
 - Первый торговый объем выкупа - Размер(объем) первой сделки по рынку (или по конкретной цене). Общий объем входа задается в параметре ТОРГОВЫЕ НАСТРОЙКИ: Торговый объем. Объем приходящийся на стеку уровней - это разница между общим объемом и объемом первой сделки по рынку. Если задано 0, то весь объем будет набран ступеням входа, т.е. сигнал - это установка сетки от цены активации. От средней по рынку будет построена сетка.
 - Тип цены закрытия уровней выкупа. Возможные значения:
   - % (процент) - процент
   - Steps – шаги цены инструмента
   - Pips - пункты цены инструмента
   - % dynamic range - процент ширины динамического канала. Если выбран режим Динамическая сетка.
 - Шаг сетки закрытия выкупа - Размер шага уровней закрытия выкупа в указанных единицах цены инструмента. Если не задан, то берется шаг закрытия сетки или основной шаг сетки, что задано. Для режима "Вид сетки уровней" = "Manual" данный параметр обязательный.
 - Торговый объем шага объема выкупа - Размер(объем) сделки на уровнях сетки для выкупленного объема. Если не задан, то берется размер "Торговый объем шага сетки". Для режима "Вид сетки уровней" = "Manual" данный параметр обязательный. Важно: Объем закрытия шага сетки выкупа должен быть кратен объему шагу сетки.
 - Цена сделки выкупа - Можно задать конкретные цены уровня выкупа. Будет установлен лимитный ордер, по исполнению оного будет сформирована сетка.

### Раздел “СТУПЕНИ ВХОДА. ТРЕЙЛ” содержит настройки:

Данный режим позволяет сдвигать сетку уровней за "убегающей" ценой, т.е. сдвигать сетку по направлению движения цены.

 - Трейлить ордера ступеней - включить режим трейла уровней.
 - Тип цены шага трейлинга уровней. Возможные значения:
   - % (процент) - процент
   - Steps – шаги цены инструмента
   - Pips - пункты цены инструмента
 - Активировать трейл после - Активация трейлинга ордеров ступеней в указанных единицах. Если указан данный параметр, то активация трейлинга произойдет только если цена прошла указанный интервал в сторону сделки.
 - Интервал проверки цены (сек.) - Данный параметр позволяет установить период проверки текущей цены инструмента. Если установлено значение 0 (значение по умолчанию), то цена будет контролироваться постоянно, при любом движении цены будет происходить контроль трейлинга. Если установить значение отличное от 0, то цена инструмента будет контролироваться с указанной периодичностью. Такая настройка позволит исключить из контроля трейлинга движения цены, прошедшие между проверками. Это в каких-то случаях позволит исключить необоснованные сдвиги ордеров ступеней при резких возвратных движениях цены, которые в обычном режиме привели бы к сдвигу ордера и неблагоприятному открытию позиции при возвратном движении цены.
 - Шаг трейла - Шаг трейлинга ордеров ступеней в указанных единицах. По мере движения цены ордера будет двигаться за ценой. Если цена прошла в сторону открытой сетки больше и равной шагу трейлинга, то ордера сдвинутся. Т.е. если необходимо обеспечить постоянный сдвиг ордеров за ценой, необходимо установить размер шага трейлинга = 1 шаг (пункт). Если шаг больше 1, то цена должна пройти данный интервал, чтобы ордера были сдвинуты. Это позволит уменьшить число транзакций по сдвигу ордеров.

Режим недоступен для активированного режима Динамическая сетка.

### Раздел “СТУПЕНИ ВХОДА. ОТЛОЖЕННАЯ АКТИВАЦИЯ” содержит настройки:

Данный режим позволяет активировать сетку по выполнению условия достижения ценового уровня. В данном режиме, в отличии от алгоритмов активации, после выполнения условия оно выключается, т.е. выполняется однократно.
 - Отложенная активация - Выбор направления активации сетки. Возможные значения:
   - 'OFF' - Выключено.
   - 'BUY' - Активация сетки на покупку
   - 'SELL' - Активация сетки на продажу
 - Условие входа - выбор условия активации условия. Возможные значения:
   - ">="
   - "<="
 - Уровень входа - уровень цены активации сетки

### Раздел “НАСТРОЙКИ СТОПА” содержит настройки:
 - Тип стоп-лосса. Возможные значения:
 - Stop - вариант установки стоп-лосса без указания информации по тейк-профиту
   - Hidden - вариант установки стоп-лосса без физического выставления заявки на серверах брокера
   - None - без установки стоп-лосса
 - Тип цены стоп-лосса. Возможные значения:
   - % (процент) - процент
   - Steps – шаги цены инструмента
   - Pips - пункты цены инструмента
   - RUR - рубли. Здесь и далее имеется ввиду сумма в рублях относительно позиции по инструменту. Допустим 100 рублей на всю позицию.
   - Price - конкретная цена
 - Стоп-лосс - значение стоп-лосса в указанных единицах. Данная настройка также выведена в главное окно скрипта, для быстрого изменения значения стоп-лосса без открытия окна настроек.
 - Типы отступа исполнения стоп-лосса. Возможные значения:
   - % (процент) - процент
   - Steps – шаги цены инструмента
   - Pips - пункты цены инструмента
 - Отступ для исполнения стоп-лосса в указанных единицах цены инструмента после активации стоп-лосса (проскальзывание).
 - Дата действия заявок типа стоп. Возможные значения:
   - GTC - до истечения срока жизни инструмента (по факту 30 дней)
   - Today - сегодня
   - Конкретная дата

### Раздел “КОНТРОЛЬ СДЕЛОК” содержит настройки

 - Комиссия - Для более точного расчета прибыли можно задать комиссию за контракт (для срочного рынка) или за объем для фондовой секции.
  - Для срочного рынка задается в валюте цены, допустим 0.5 рублей.
  - Для фондовой секции задается в процентах за объем сделки.
 - Лимит по прибыли по достижению которого алгоритм закроет позицию, снимет активную сетку и перейдет в режим ожидания.
 - Лимит по убытку по достижению которого алгоритм закроет позицию, снимет активную сетку и перейдет в режим ожидания.
 - Команда: Сбросить накопленные данные по прибыли.
 - Автоочистка данных по прибыли - Режим автоматической очистки данных прибыли при наступлении нового торгового дня. Возможные значения:
   - OFF   - Выключено
   - DAY   - Каждый новый торговый день
   - WEEK  - Каждую новую торговую неделю
 - Сохранять журнал сделок - если включено, то будут сохраняться все сделки в файлы для каждого инструмента.
 - Открыть сделки - команда, открывающая окно закрытых сделок по инструменту.


### В скрипте (и в окне настроек) действуют следующие правила редактирования значения параметров:

 - Все поля, содержащие в своем значении текст “[...]” - это команды, выбираемые указателем (двойное нажатие). При этом двойное нажатие левой клавишей указателя - это изменение значение вправо по списку значений. Двойное нажатие правой клавишей указателя - это изменение значение влево по списку значений. Для примера, набор значений {'Stop+Profit', 'Stop', 'Hidden', 'None'} при выборе левой клавишей мы переходим слева направо по значениям. И обратно для двойного нажатия левой клавишей указателя.
 - Все редактируемые (числовые, строковые) поля окрашиваются в желтый цвет. Чтобы начать редактировать поле необходимо выделить необходимое поле. Далее можно привычными командами с клавиатуры ввести необходимое значение показателя. При этом, если это необходимо, удалить старое значение.
 - Также числовые поля и поля, содержащие дату (Дата действия заявок, автоматический запуск и остановка), можно изменять с помощью клавиш “стрелка влево” - уменьшить значение, “стрелка вправо” - увеличить значение. Тем самым можно быстро изменить значение, не вводя его с клавиатуры.
 - Ввод значения “прямо” с клавиатуры возможно производить только при остановленной торговле по инструменту. Это ограничение введено т.к. при вводе значения можно допустить ошибку ввода.
 - Изменение значения через плавное изменение клавишами “стрелка влево” и “стрелка вправо” возможны при работающем роботе, т.к. при таком способе ввода исключается синтаксическая ошибка.
 - Часть команд настроек “[...]” доступна при работающем скрипте по инструменту. Допустим, для примера, можно включить и остановить трейлинг стоп-лосса. Можно изменить тип стоп-лосса, тейк-профита при этом произойдет перевыставление ордеров в соответствии с указанными настройками. Допустим, изменив тип тейк-профита с стопа на лимитный ордер, произойдет его перевыставление. Если строка инструмента находится в остановленном состояния, то реакция на изменение настроек произойдет только после запуска торговли по инструменту.
 - В поле "Message" выводятся сообщения по строке алгоритма. Если дважды нажать правой клавишей указателя по полю в стоке, то откроется дополнительное окно всех ранее выведенных сообщений по строке.


Скрипт поддерживает горячие клавиши:

 - Остановить все строки - Shift + 1
 - Запустить все строки - Shift + 2
 - Сдвинуть строку вниз - Shift + "-"
 - Сдвинуть строку вверх - Shift + "+"
 - Скопировать строку - Sift + C.  Для корректной работы необходимо выбрать строку не в поле выбора инструмента.

### Работа скрипта.

Для запуска торговли по инструменту необходимо изменить состояние строки по инструменту, исполнив команду в поле “state”. Таким же образом происходит остановка торговли по строке скрипта. Для удаления строки из скрипта необходимо выбрать команду “Del” в первой колонке [...].
При изменении позиции по инструменту скрипт выведет значение в поле “Position”. Это происходит даже при остановленной торговле по инструменту.

Если строка находится в состоянии “Run” и введены настройки установки стоп-ордеров и сетки ордеров, то по команде установки сетки ордеров произойдет автоматическая постановка соответствующих ордеров.

Если происходит дальнейшее изменение позиции, то скрипт отслеживает изменение позиции и перевыставляет ордера в соответствии с новой позицией и новой средней ценой.

Если происходит закрытие позиции, то скрипт автоматически снимает установленные стоп ордера.

При подаче команды на установку сетки ордеров происходит анализ настроек. Если включен режим выкупа, устанавливается ордер на торговый объем выкупа (вход по рынку). При его исполнении происходит заполнение уровней сетки и установка ордеров сетки.

Также можно организовать несколько наборов позиции. Допустим, уже был набран объем и вся сетка выбрана. Изменив торговый объем в большую сторону, можно установить новую сетку на новых уровнях выполнив еще раз команду установки сетки. Либо, если цена ушла за последний уровень, то будет открыт еще один уровень, если доступен торговый объем. Т.е. можно открыть сетку на начальный объем, увеличить торговый объем, и он будет установлен только если цена опустится до последнего уровня.

Если для инструмента срочной секции в клиринг были сняты лимитные ордера входа в позицию, то после начала торговой сессии ордера будут восстановлены.

Для каждой строки можно контролировать сетку уровней через дополнительное окно сетки уровней:

В этом окне можно быстро выключить активность уровня, что приведет к снятию ордера.

  ![](/assets/images/net/active_net_window.PNG)


В этом окне можно быстро выключить активность уровня, что приведет к снятию ордера.

Если выполнить команду "Калькулятор инструмента" из окна настроек или команду "+/-" из основного окна, то откроется окно калькулятора по инструменту:

  ![](/assets/images/net/calculus_window.PNG)

В этом окне можно рассчитать взаимные значения между введенными параметрами. Также выводится справочная информация по инструменту.

Также скрипт поддерживает отправку сообщений в Телеграм, E-Mail, реализованную через библиотеку [библиотеку](/2021-03-14/teleMessage)
