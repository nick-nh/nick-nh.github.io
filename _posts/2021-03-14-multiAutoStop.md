---
layout: post
title: "Скрипт multiAutoStop"
author: "nnh"
description: Скрипт multiAutoStop.
tags: [скрипт,lua,qlua,квик,quik,автостоп]
---

Реализация автоматической установки стоп, профит ордеров по открытым позициям, сопровождение позиции в терминале Квик.

[Видео работы скрипта](https://www.youtube.com/watch?v=RmSxmCza0rE)

##	Основные возможности скрипта
В процессе работы скрипт отслеживает изменение позиции по торгуемому инструменту и выводит информацию по ней. Если установлены настройки установки стоп-лосса, тейк-профита, то происходит автоматическая установка ордеров, отвечающих за стоп-лосс и тейк-профит.
Также реализована возможность закрыть половину позиции при достижении указанного ценового уровня.
Если установлены настройки по трейлингу стопа-лосса, то по мере движения цены происходит сдвиг стоп-лосса, что позволяет защитить полученную прибыль. Скрипт отслеживает ручные сдвиги стоп-лосса и тейк-профита на графике цены инструмента, тем самым позволяя управлять размером стоп-лосса и тейк-профита без остановки скрипта.

Поддерживается автоматический запуск и остановка исполнения скрипта по конкретному торгуемому инструменту по времени. Существует возможность автоматически закрыть позицию по инструменту по истечении времени.
Для срочного рынка (фьючерсы) поддерживается возможность автоматической замены торгуемого инструмента на следующий.

Поддерживаются виды стоп-лосса:
 - Stop+Profit - вариант установки стоп-лосса и тейк-профита одной заявкой
 - Stop - вариант установки стоп-лосса без указания информации по тейк-профиту
 - Hidden - вариант установки стоп-лосса без физического выставления заявки на серверах брокера
 - None - без установки стоп-лосса


Поддерживаются виды тейк-профита:
 - Stop+Profit - вариант установки стоп-лосса и тейк-профита одной заявкой
 - Stop - вариант установки тейк-профита без указания информации по стоп-лоссу
 - Limit - вариант установки тейк-профита с использованием заявки типа “Лимитный ордер”
 - Hidden - вариант установки тейк-профита без физического выставления заявки на серверах брокера
 - None - без установки тейк-профита


Поддерживаются виды указания значения величины стоп-лосса и тейк-профита от средней цены позиции:
 - % (процент) - процент
 - Steps – шаги цены инструмента
 - Pips - пункты цены инструмента
 - RUR - рубли
 - Price - конкретная цена


Поддерживаются виды указания времени жизни стоп-ордеров:
 - GTC - до истечения срока жизни инструмента (по факту 30 дней)
 - Today - сегодня
 - Конкретная дата


Поддерживаются виды указания типы отступа и спреда для стоп--профит-ордера:
 - % (процент) - процент
 - Steps – шаги цены инструмента
 - Pips - пункты цены инструмента


Поддерживаются виды указания значения трейлинга стоп-лосса:
 - % (процент) - процент
 - Steps – шаги цены инструмента
 - Pips - пункты цены инструмента
 - RUR - рубли

Скрипт отслеживает установленное соединение с сервером брокера, время торговой сессии по инструменту, исключая подачи команд на сервер брокера в периоды отсутствия соединения с сервером брокера, неторговое время (клиринг, окончание торговой сессии). После восстановления соединения с сервером брокера происходит проверка полученных пакетов (если включена такая настройка), дабы избежать запуска алгоритма на неполных данных.

Скрипт корректно отрабатывает закрытие торгового терминал без остановки скрипта. После перезапуска терминала скрипт автоматически запустится, перейдет в период ожидания подключения к серверу брокера, загрузки всех информационных пакетов с сервера брокера.
Для каждого запуска формируется файл лога в каталоге /logs. Если в поцессе работы скрипта возникнут ошибки, то будет дополнительно сформирован файл лога ошибок. Если ошибок будет слишком много, то скрипт принудительно остановится.

##	Окно настроек скрипта.
Для настройки торговых параметров по инструменту необходимо выполнить команду “[...]” в поле “Set”. В результате будет показана форма настроек.

![](/assets/images/mas/mAS_0.PNG)

Большинство параметров содержат описание. Его можно вызвать по кнопке "?".

![](/assets/images/mas/mAS_2.PNG)

### Раздел “ОБЩИЕ НАСТРОЙКИ” содержит настройки:

 - Идентификатор скрипта - комментарий, добавляемый к транзакциям. По нему можно будет определить ордера и сделки, совершенные скриптом.
 - Запустить при запуске - автоматический запуск строк скрипта при запуске.
 - Время автозапуска - конкретное время для автозапуска. Указывается как строка вида ЧЧ:ММ:СС. Либо ЧЧ:ММ. Если указано, то настройка "Запустить при автозапуске" не работает.
 - Время автоостановки - время остановки сроки скрипта. Указывается как строка вида ЧЧ:ММ:СС. Либо ЧЧ:ММ.
 - автоматическое закрытие позиции по времени автоостановки.
 - Заменять инструмент на следующий за указанное число дней до экспирации. Важно: происходит только замена инструмента в строке скрипта. Позиция и уже выставленные ордера при этом не затрагиваются.
 - Идентификатор графика куда будут выводиться метки сделок в виртуальном режиме работы. Также метки скрытых стоп-ордеров. Задается в разделе "Дополнительно" свойств цены графика.
 - Отправлять сообщения в Телеграм.
 - Отправлять сообщения E-Mail.

### Раздел “ТОРГОВЫЕ НАСТРОЙКИ” содержит настройки:

 - ВИРУТАЛЬНАЯ ТОРГОВЛЯ - режим эмуляции торговли. В этом режиме команды BUY, SELL из основного окна скрипта не будут приводить к совершению реальных сделок. Вместо этого сделки будут совершаться "в памяти". Также будут выводиться метки совершенных сделок на график, если заполнен параметр "Идентификатор графика". Стоп ордера также будут скрытыми. Этот режим будет полезен для проверки торговых идей в условиях максимально приближенных к реальным.
 - Торговый объем - размер(объем) выставляемой лимитной заявки. Данная настройка также выведена в главное окно скрипта, для быстрого изменения значения.
 - Отступ заявки по рынку - при подаче заявки по рынку необходимо указать цену, сдвинутую на число шагов от текущей, чтобы она гарантировано исполнилась. Данный параметр важен при торговле на срочном рынке, т.к. от цены заявки зависит расчет ГО. Также в моменты высокой волатильности данный параметр позволит отрегулировать отступ для рыночной заявки.
 - Проверять лимиты - при подаче заявки проверить доступность денежных средств.
 - Проверять лимиты цен - при подаче заявки проверить что цена заявки в допустимом диапазоне цен.
 - Ожидание при сдвиге ордера (сек.) - если установлен стоп-ордер и пользователь сдвинул его на графике на новый ценовой уровень, то скрипт ждет его появления, прежде чем перевыставить новый ордер. Если пользователь просто случайно (по ошибке) снял его, то скрипт через указанной время выставит заново стоп ордер.

### Раздел “НАСТРОЙКИ СТРОПА” содержит настройки:

 - Тип стоп-лосса. Возможные значения:
 - Stop+Profit - вариант установки стоп-лосса и тейк-профита одной заявкой
 - Stop - вариант установки стоп-лосса без указания информации по тейк-профиту
 - Hidden - вариант установки стоп-лосса без физического выставления заявки на серверах брокера
 - None - без установки стоп-лосса
 - Тип цены стоп-лосса. Возможные значения:
 - % (процент) - процент
 - Steps – шаги цены инструмента
 - Pips - пункты цены инструмента
 - RUR - рубли. Здесь и далее имеется ввиду сумма в рублях относительно позиции по инструменту. Допустим 100 рублей на всю позицию.
 - Price - конкретная цена
 - Стоп-лосс - значение стоп-лосса в указанных единицах. Данная настройка также выведена в главное окно скрипта, для быстрого изменения значения стоп-лосса без открытия окна настроек.
 - Отступ для исполнения стоп-лосса в указанных единицах цены инструмента после активации стоп-лосса (проскальзывание).
 - Дисциплинированный стоп - настройка, запрещающая сдвинуть стоп. Если активирован этот режим, то любое изменение стопа приведет к его снятию и восстановлению состояния.
 - Триггерный скрытый стоп - Режим стоп заявки, который активируется по событиям. Настройки триггерного стопа:

![](/assets/images/mas/mAS_3.PNG)

 - Интервал триггерного стопа - интервал баров для триггерного стопа.
 - Режимы триггерного стопа:
 - "Bar Close" -  по закрытию бара. В этом режиме активация стопа происходит не по движению цена, а если бар закрылся выше (ниже) текущего стопа. Важно: данный режим возможен только если активирован тип стоп-лосса "Hidden.
 - "EMA"       -  по пересечению EMA. Если очередной бар закрывается за EMA, то происходит принудительное закрытие позиции.
 - "MACD"      -  если MACD последнего закрытого бара пересекает 0, то происходит принудительное закрытие позиции
 - "RSI"       -  если RSI последнего закрытого бара пересекает уровень, то происходит принудительное закрытие позиции
 - Поведение триггерного стопа, когда возникает триггерный сигнал. Возможные значения:
 - Close - как только возникает сигнал по одному из алгоритмов, позиция будет закрыта.
 - Shift Stop     - сдвинуть стоп за минимум|максимум бара. Если цена пойдет дальше, то стоп сработает, если это было ложно движение, то позиция останется.
 -  Важно: Данная настройка работает только для режимов: EMA|MACD|RSI
 - Отступ стоп цены при сдвиге (шагов) - Если выбран режим поведения триггерного стопа "Shift Stop", то данный параметр задает величину смещения относительно уровня в шагах цены для сдвига стоп-ордера. Для примера, при позиции ЛОНГ бар закрылся за линией EMA, выбран режим "Shift Stop". Произойдет сдвиг стоп-ордера за минимум бара. При этом стоп-ордер будет установлен на уровень Low бара - сдвиг
 - Для режимов необходимо указать соответствующие настройки.

### Раздел “НАСТРОЙКИ ПРОФИТА” содержит настройки:

 - Тип цены тейк-профита. Возможные значения:
 - % (процент) - процент
 - Steps – шаги цены инструмента
 - Pips - пункты цены инструмента
 - RUR - рубли
 - Price - конкретная цена
 - Тип тейк-профита. Возможные значения:
 - Stop+Profit - вариант установки тейк-профита и тейк-профита одной заявкой
 - Stop - вариант установки тейк-профита без указания информации по тейк-профиту
 - Limit - вариант установки тейк-профита с использованием заявки типа “Лимитный ордер”
 - Hidden - вариант установки тейк-профита без физического выставления заявки на серверах брокера
 - None - без установки тейк-профита
 - Тейк-профит - значение тейк-профита в указанных единицах. Данная настройка также выведена в главное окно скрипта, для быстрого изменения значения стоп-лосса без открытия окна настроек.
 - Многоступенчатый тейк-профит - признак указания нескольких тейк-профитов. Работает если тип стоп-лосса не указан как Stop+Profit.
 - Тип многоступенчатого тейк-профита:
 - Qty % - процентами от открытой позиции. В этом режиме указываются шаги тейк-профита с указанием процента закрываемой позиции и размера тейк-профита шага.
 - Steps – шаг ступеней тейк-профита. В этом режиме размер тейк-профита - это значение в поле "Тейк-профит" основных настроек. А каждая последующая ступень будет установлена через указанный шаг а поле "Шаг ступеней тейк-профита". Ступеней будет установлено столько сколько необходимо для покрытия всей открытой позиции. Количество на каждом шаге - это значение из поля "Количество на каждом шаге тейк-профита".
 - Шаг ступеней тейк-профита - для режима "Тип многоступенчатого тейк-профита" "Steps". Значение шага ступеней тейк-профита в указанных единицах.
 - Количество на каждом шаге тейк-профита (в лот) - для режима "Тип многоступенчатого тейк-профита" "Steps".
 - Настроить ступени тейк-профита - если включен режим "Многоступенчатый тейк-профит" и включен режима "Тип многоступенчатого тейк-профита" "Qty %", то по этой команде откроется окно ввода значений тейк-профита.

![](/assets/images/mas/mAS_1.PNG)

В данном окне можно указать уровни тейк-профита в единицах, указанных в настройке "Тип цены тейк-профита". Значения имеют тот же смысл что значение Тейк-профит в окне настроек.
Если необходимо указать два тейк-профита в 75 и 100 шагов цены, то настройка "Тип цены тейк-профита" имеет значение "Steps", а в строке вводим 75 в колонке "take_profit".
В колонке "qty (%)" указывается объем, который относится к этому тейк профиту. Допустим, на первом шаге мы хотим закрыть 30% от позиции. Тогда в поле вводится значение 30. Аналогично для второй строки.
В приведенном выше примере будут установлены три тейк-профита на 75, 100 и 150 	шагов цены. Первый и второй уровни - 30% от объема позиции.
Т.о. вводятся все уровни тейк-профита. Если на последнем уровне необходимо закрыть остаток позиции, то для этого необходимо ввести в поле "qty (%)" значение 0.

Важно: сумма процентов уровней не должна превышать 100%.
Также с помощью этой настройки можно ввести тейк-профит на часть позиции, не закрывая все позицию. Допустим только 50%. Остальная позиция не будет закрыта по тейк-профиту (а, допустим, по трейл-стопу).
Для этого достаточно ввести одну строку с указанием уровня тейк-профита и необходимым объемом, допустим 50%.


 - Дата действия заявок типа стоп. Возможные значения:
 - GTC - до истечения срока жизни инструмента (по факту 30 дней)
 - Today - сегодня
 - Конкретная дата
 - Типы отступа и спреда для стоп-профит-ордера. Возможные значения:
 - % (процент) - процент
 - Steps – шаги цены инструмента
 - Pips - пункты цены инструмента
 - Отступ - значение отступа для тейк-профита в указанных единицах
 - Спред  - значение спреда для тейк-профита в указанных единицах
 - Не искать заявки с комментарием - в процессе работы скрипт ищет установленные стоп-ордера. Если стоп-ордер будет содержать этот комментарий, то такой ордер не будет рассматриваться в процессе поиска.


### Раздел “НАСТРОЙКИ ТРЕЙЛА” содержит настройки:
 - Тип цены трейлинга стоп-лосса. Возможные значения:
 - % (процент) - процент
 - Steps – шаги цены инструмента
 - Pips - пункты цены инструмента
 - RUR - рубли
 - Перевести в безубыток после указанного значения минут. Данная настройка позволяет переводить стоп-лосс в значение средней цены позиции, если не происходило движение цены.
 - Перевести в безубыток после движения цены в указанных единицах.
 - Перевести в безубыток после ТП1 - если включен режим "Многоступенчатый тейк-профит", то включение данной настройки позволит перевести в безубыток стоп-лосс при исполнении первого уровня тейк-профита.
 - Сдвиг безубытка в указанных единицах - сдвиг стопа при переносе в безубыток. Стоп будет установлен по цене позицее выше (ниже) на указанный размер сдвига.
 - Интервал проверки цены (сек.) - данный параметр позволяет установить период проверки текущей цены инструмента. Если установлено значение 0 (значение по умолчанию), то цена будет контролироваться постоянно, при любом движении цены будет происходить контроль трейлинга.  Если установить значение отличное от 0, то цена инструмента будет контролироваться с указанной периодичностью. Такая настройка позволит исключить из контроля трейлинга движения цены прошедшие между проверками. Это в каких-то случаях позволит исключить необоснованные сдвиги стоп-ордера при резких возвратных движениях цены, которые в обычном режиме привели бы к сдвигу стоп-ордера и закрытию позиции при возвратном движении цены.
 - Шаг трейлинга стоп-лосса в указанных единицах. По мере движения цены стоп-лосс будет двигаться за ценой. Если цена прошла в сторону открытой сделки больше и равной шагу трейлинга, то стоп-лосс сдвинется. Т.о. если необходимо обеспечить постоянный сдвиг стоп-лосса за ценой, необходимо установить размер шага трейлинга = 1 шаг (пункт). Если шаг больше 1, то цена должна пройти данный интервал, чтобы стоп был сдвинут. Это позволит уменьшить число транзакций по сдвигу стоп-ордера.
 - Скользящий стоп в указанных единицах - размер стопа после активации трейлинга. Когда трейлинг активировался, размер стоп-лосс будет рассчитан с использованием данного параметра. Если указано значение 0, то размер стопа будет равен изначальному размеру стоп-лосса.
 - Начало трейлинга стоп-лосса в указанных единицах. Если указан данный параметр, то активация трейлинга произойдет только если цена прошла указанный интервал в сторону сделки.


### Раздел “НАСТРОЙКИ ПОЗИЦИИ” содержит настройки:
 - Уровень (цена) входа - в данном поле можно указать корректный уровень входа в позицию. Это может понадобится в тех случаях, когда скрипт не смог корректно рассчитать среднюю цену входа текущей позиции. Данная ситуация возможна, когда скрипт был запущен когда позиция уже была сформирована, а сделки (или их часть) отсутствуют в терминале. Допустим, сделки были несколько торговых сессий назад. В этом случае, указывая корректное значение, скрипт сможет правильно установить стоп-лосс и тейк-профит.


### В скрипте (и в окне настроек) действуют следующие правила редактирования значения параметров:

 - Все поля, содержащие в своем значении текст “[...]” - это команды, выбираемые указателем (двойное нажатие). При этом двойное нажатие левой клавишей указателя - это изменение значение вправо по списку значений. Двойное нажатие правой клавишей указателя - это изменение значение влево по списку значений. Для примера, набор значений {'Stop+Profit', 'Stop', 'Hidden', 'None'} при выборе левой клавишей мы переходим слева направо по значениям. И обратно для двойного нажатия левой клавишей указателя.
 - Все редактируемые (числовые, строковые) поля окрашиваются в желтый цвет. Чтобы начать редактировать поле необходимо выделить необходимое поле. Далее можно привычными командами с клавиатуры ввести необходимое значение показателя. При этом, если это необходимо, удалить старое значение.
 - Также числовые поля и поля, содержащие дату (Дата действия заявок, автоматический запуск и остановка), можно изменять с помощью клавиш “стрелка влево” - уменьшить значение, “стрелка вправо” - увеличить значение. Тем самым можно быстро изменить значение, не вводя его с клавиатуры.
 - Ввод значения “прямо” с клавиатуры возможно производить только при остановленной торговле по инструменту. Это ограничение введено т.к. при вводе значения можно допустить ошибку ввода.
 - Изменение значения через плавное изменение клавишами “стрелка влево” и “стрелка вправо” возможны при работающем роботе, т.к. при таком способе ввода исключается синтаксическая ошибка.
 - Часть команд настроек “[...]” доступна при работающем скрипте по инструменту. Допустим, для примера, можно включить и остановить трейлинг стоп-лосса. Можно изменить тип стоп-лосса, тейк-профита при этом произойдет перевыставление ордеров в соответствии с указанными настройками. Допустим, изменив тип тейк-профита с стопа на лимитный ордер, произойдет его перевыставление. Если строка инструмента находится в остановленном состояния, то реакция на изменение настроек произойдет только после запуска торговли по инструменту.
 - В поле "Message" выводятся сообщения по строке алгоритма. Если дважды нажать правой клавишей указателя по полю в стоке, то откроется дополнительное окно всех ранее выведенных сообщений по строке.
