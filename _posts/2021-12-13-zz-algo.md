---
layout: post
title: "Зиг-Заг"
author: "nnh"
description: Зиг-Заг для Квика
tags: [индикатор,lua,qlua,квик,quik]
---

В терминале Квик нет встроенного индикатора Зиг-Заг, также нет возможности вывести "Вилы Эндрюса" на график. Попробуем это исправить.

Теперь про сам индикатор. [Его можно взять здесь](https://github.com/nick-nh/qlua/blob/master/smartZZ2/zz_algo.lua).

## Настройки индикатора
<br>

Индикатор добавляется стандартным образом: необходимо разместить файл индикатора в папке Luaindicators терминала (если ее нет, то создать).

В результате индикатор можно будет добавить на график.
<br>
![](/assets/images/zz_algo/zz1.PNG)
<br>

Настройки:
- ['Вариант расчета']                                 = 'Extr; Range; *ATR', -- Тип расчета ZZ: Extr; Range; ATR
- ['Тип отступа']                                     = '*%; Steps',
- ['Размер отступа']                                  = 6, -- Размер отступа от вершины для начала нового тренда. Выражен в зависимости от выбранного вида расчета и типа отступа.
- ['Окно поиска вершины (бар)']                       = 24, --Глубина поиска новой вершины. Если за указанное число баров появился новый экстремум, то он берется в анализ
- ['Рассчитывать уровни диапазона']                   = 0, -- показывать уровни от прошлого движения
- ['Показывать расширения уровней']                   = 0, -- показывать расширения уровней от прошлого движения
- ['Вариант расчета уровней']                         = 2, -- 1- последнее движение, 2 - последний максимальный диапазон
- ['Глубина поиска последнего диапазона по вершинам'] = 10, -- глубина поиска последнего максимального диапазона по вершинам. До 20.
- ['Показывать уровни от вершин']                     = 0, -- показывать уровни от вершин
- ['Число уровней от вершин']                         = 10, -- сколько показывать уровней от вершин до 20
- ['Число исторических уровней от вершин']            = 0, -- сколько показывать уровней от вершин для исторических данных
- ['Показывать центр волны']                          = 1, -- показывать центр движения для вил Эндрюса
- ['Число центров волны']                             = 3, -- глубина показа COG
- ['Показывать целевую зону']                         = 1, -- показывать целевую зону
- ['Показывать вилы Эндрюса']                         = 1, -- показывать вилы Эндрюса
- ['Сдвиг вершин для вил Эндрюса']                    = 1, -- сдвиг вершин вилы Эндрюса
- ['Показывать регрессионный канал']                  = 0, -- показывать регрессию
- ['Ширина регрессионного канала']                    = 1, -- ширина канала регрессии (стандартное отклонение)
- ['Число волн для целевой зоны по среднему']         = 5, -- глубина поиска движений для предсказания
- ['Ширина целевой зоны по среднему %']               = 10, -- диапазон целевой зоны (%)
- ['Показывать метку паттерна']                       = 1, -- показывать метку паттерна
- ['Показывать расширение фибоначчи']                 = 1, -- показывать расширение фибо волны
- ['Отступ метки от вершины']                         = 100, -- сдвиг метки от вершины
- ['Идентификатор графика']                           = ''

### Вид расчета
Варианты:
 - Extr  - от прошлой вершины. Если цена прошла от вершины размер отступа, то это смена тренда.
 - Range - в % от прошлой волны. В этом режиме параметр offset_type должен быть равен %. Если цена прошла указанный процент от прошлой волны, то это смена тренда.
 - ATR   - для смены тренда цена должна пройти ATR*offset_value

Чтобы задать значение необходимо добавить символ * перед вариантом в строке значения.
<br>

#### Вариант Extr

Представим, что у нас есть некий максимум на отрезке баров (задается параметром ['Окно поиска вершины (бар)']). Теперь цена ниже и у нас есть новый минимум на том же отрезке. Если не накладывать никаких фильтров, то по этим двум точкам уже можно провести линию.
Если продолжать этот же алгоритм дальше, то мы получим вершины.

Теперь будем принимать в расчет только те вершины, если от прошлой прошли определенное расстояние. Проверяем, что если новая вершина отстоит от прошлой больше чем порог, то мы ее учитываем как новую. Иначе пропускаем.
Для режима Extr доступны два варианта отступа
 - %        - выраженный в процентах
 - Steps    - выраженный в шагах цены

Т.о. если цена прошла больше чем отступ, то вершина сформирована. Величина отступа задается в параметре ['Размер отступа'].

#### Вариант Range

Отличие этого варианта в том, что мы проверяем не расстояние от вершины, а сколько процентов прошла цена от прошлой волны. Т.е. если волна большая, то и движение для смены волны необходимо пройти больше.

#### Вариант ATR

Этот вариант похож на вариант Extr, но при этом размер необходимого отступа рассчитывается исходя из ATR на отрезке ['Окно поиска вершины (бар)']. Т.о. этот режим учитывает волатильность на участке временного ряда.

### Информационна Метка

Чтобы вывести метку на график необходимо задать идентификатор графика в параметре ['Идентификатор графика'] и установить параметр ['Показывать метку паттерна'] = 1.

Идентификатор графика задается в настройках цены
<br>
![](/assets/images/zz_algo/zz2.PNG)
<br>

Метка содержит информацию о соотношениях в процентах последних пяти волн, объеме на отрезке каждой волны, числу бар.

### Рассчитывать уровни диапазона

Если задать значение ['Рассчитывать уровни диапазона'] = 1, то будут выведены промежуточные уровни диапазона на подобие уровней Мюррея, рассчитанные как диапазон/4
<br>
![](/assets/images/zz_algo/zz3.PNG)
<br>

Если задать значение ['Показывать расширения уровней'] = 1, то будут дополнительно выведены промежуточные уровни, рассчитанные как диапазон/8 и дополнительные за границами диапазона. Всего их 12.
<br>
![](/assets/images/zz_algo/zz4.PNG)
<br>

Вариант расчета диапазона, от которого происходит расчет задается в параметре ['Вариант расчета уровней'].

Варианты:
 - 1 - последнее движение. Т.е. в качестве диапазона будет взята прошлая сформированная волна.
 - 2 - последний максимальный диапазон. В этом случае будет найден максимум и минимум по числу вершин, заданному в параметре ['Глубина поиска последнего диапазона по вершинам']

### Показывать уровни от вершин

Если задать значение ['Показывать уровни от вершин'] = 1, то будут выведены линии от вершин. Число линий задается в параметре ['Число уровней от вершин']. Но если уровень отстоит от текущей цены больше чем на 50%, то всего будет выведено не более 5- линий от последних 5-и вершин.
<br>
![](/assets/images/zz_algo/zz5.PNG)
<br>

Если задать значение ['Число исторических уровней от вершин'], то будут дополнительно выведены линии от вершин, которые были на исторических данных. Для примера, были некие вершины, сформированные далеко на истории. Теперь цена подходит к тем же ценовым уровням, что и тогда.
Допустим, ['Число исторических уровней от вершин'] = 5. В этом случае от текущей цены будут найдены пять ближайших (относительно цены) вершин вверх и пять вниз, и показаны линии от этих вершин.
<br>
![](/assets/images/zz_algo/zz6.PNG)
<br>

### Показывать целевую зону

Если задать значение ['Показывать целевую зону'] = 1, то будут выведены целевые зоны движения цены в рамках текущей волны. Т.е. некий прогноз движения.

Целевая зона рассчитывается по паттернам соотношений последних 5 точек XABCD (или ABCDE)

Используются такие соотношения между волнами для определения целей:

    -- Алгоритм: проверка размера волн и корректировка по следующим от- |
    -- ношениям "Идеальных пропорций" ("Золотое сечение" версия 1):     |
    -- (в терминах XABCD точки равны: A = X, B = A, C = B, D = B, E = D)|
    --   №    (D-E)/(D-C)   "ЗС версия1" №  (E-D)/(C-D)   "ЗС версия1"  |
    --   M1    2             1.618       W1  0.3334        0.3819       |
    --   M2    0.5           0.5         W2  0.6667        0.618        |
    --   M3    1.5           1.2720      W3  1.5           1.2720       |
    --   M4    0.6667	     0.618       W4  0.5           0.5          |
    --   M5    1.3334        1.2720      W5  2             1.618        |
    --   M6    0.75          0.618       W6  0.25          0.25         |
    --   M7    3             3.0000      W7  0.5           0.5          |
    --   M8    0.3334        0.3819      W8  2             1.618        |
    --   M9    2             1.618       W9  0.3334        0.3819       |
    --   M10   0.5           0.5         W10 3             3.0000       |
    --   M11   0.25          0.25        W11 0.75          0.618        |
    --   M12   2             1.618       W12 1.3334        1.2720       |
    --   M13   0.5           0.5         W13 0.6667        0.618        |
    --   M14   1.5           1.2720      W14 1.5           1.2720       |
    --   M15   0.6667        0.618       W15 0.5           0.5          |
    --   M16   0.3334        0.3819      W16 2             1.618        |

Найденный паттерн выдает
 - целевую зону - это светло зеленая линия.
 - зону возможного продолжения движения - темно зеленая линия
 - зону коррекции - темно синяя линия.

Если же не был найден паттерн, то целевая зона будет рассчитана как простое среднее от прошлых ['Число волн для целевой зоны по среднему'] волн текущего направления. И зона будет выведена в виде канала шириной ['Ширина целевой зоны по среднему %']

### Показывать расширение фибоначчи

Если задать значение ['Показывать расширение фибоначчи'] = 1, то будут выведены целевые зоны движения цены расширения Фибоначчи, построенные по трём последним точкам. Линии выводятся как черные пунктирные линии по направлению текущей волны.
Выводятся значения 100%, 161.8%, 261.8%, 423.6%. Уровни 261.8%, 423.6% выводятся если пробиты уровни 100%, 161.8%.

### Показывать регрессионный канал

Если задать значение ['Показывать регрессионный канал'] = 1, то будут выведен канал, построенный методом линейной регрессии (МНК) по точкам из вершин.

Число вершин для расчета задаётся параметром ['Число уровней от вершин'].
Ширина регрессионного канала (в стандартных отклонениях) задается параметром ['Ширина регрессионного канала'].

<br>
![](/assets/images/zz_algo/zz7.PNG)
<br>

### Показывать вилы Эндрюса

Если задать значение ['Показывать вилы Эндрюса'] = 1, то будут выведены линии формирующие так называемые "Вилы Эндрюса".

По умолчанию они строятся по последним точкам ABC исключая последнюю. Т.е. показывают направление текущей волны.
Сдвиг относительно последней вершины задаётся параметром ['Сдвиг вершин для вил Эндрюса']

<br>
![](/assets/images/zz_algo/zz8.PNG)
<br>

### Показывать центр волны

Если задать значение ['Показывать центр волны'] = 1, то будут выведены точки по центру сформированной волны. Число выводимых точек задается параметром ['Число центров волны'].