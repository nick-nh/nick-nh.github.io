---
layout: post
title: "Скрипт transactionPocket"
author: "nnh"
description: Cкрипт "Карман транзакций" для Квика.
tags: ["карман_транзакций",скрипт,робот,lua,qlua,квик,quik]
---

<br>
В терминале Квик есть такой инструмент как "Карман транзакций". Он позволяет сохранить транзакции "на будущее". Одна проблема - ручное управление списком и необходимость отслеживать уже исполненные транзакции.
Мне был необходим инструмент, с помощью которого можно было бы формировать список транзакций, а также чтобы он автоматически отслеживал все действия с заявками. В конечном итоге, постоянно следить за ходом торгов не всегда удается,
да и нет особого желания постоянно смотреть за графиками.

Мой основной метода торговли на фондовой секции - это торговля от уровней. С какой-то периодичностью определяются уровни цен, по которым хотелось бы совершить сделки. Это можно делать постоянно, а можно редко. Но раз уровень определен,
то необходимо чтобы заявка устанавливалась пока не исполнится или пока не будет отменена.

Допустим, мы устанавливаем некую заявку через график, стакан или просто по команде терминала. После того как заявка будет установлена, нам надо, чтобы она автоматически устанавливалась каждую торговую сессию.
Или мы изменяем уже установленную заявку (допустим, сдвигаем на новй уровень), точно также необходимо чтобы старая заявка исчезла из списка запомненных, а новая продолжала устанавливаться. Это первое и главное требование.

Также необходима возможность ввести в список транзакцию по цене вне допустимого торгового диапазона, т.к. ее нельзя установить в данный момент. Это необходимо для того, чтобы когда цена будет внутри допустимого ценового
диапазона, то была бы автоматически подана транзакция в торговую систему. Допустим, расширили ценовой диапазон в процессе торгов. Не всегда удается отследить это событие руками.

Также необходима возможность устанавливать заявки на закрытие позиции, купленной по уровню. Допустим, по ранее установленной заявке, был куплен инструмент по цене 100. Можно отследить это событие и установить заявку на продажу, чтобы она ждала своего исполнения.
Или можно уже при формировании заявки на открытие позиции сразу определить, что мы хотим закрыть позицию по цене, допустим 120. Т.е. необходимо иметь возможность указывать ценовой отступ, по которому определится уровень
куда будет установлена заявка сразу после исполнения первичной заявки. Т.к. значение отступа сохраняется при формировании встречной заявки, то после ее исполнения снова будет установлена заявка (которая будет уже встречной для нее)
на тот же уровень, где была первоначальная заявка. Т.о. будут автоматически устанавливаться заявки по заранее определенным уровням.

В результате этих требований был написан скрипт, реализующий данную функциональность.

По вопросам приобретения данного скрипта обращайтесь.

[Небольшое видео работы скрипта](https://youtu.be/6mlHdVAhClI)
<br><br>

## Установка скрипта
<br>
Скрипт поставляется в виде архива. Который можно распаковать по любому местоположению.

Папка transactionPocket содержит:

Основной файл для запуска в Квике - это transactionPocket.lua

- файл T.state - сохраняемое состояние скрипта между запусками
- файл transactionPocket_params.txt - технические параметры для работы скрипта
- подкаталог logs - файлы логирования в процессе исполнения скрипта
- подкаталог history - файлы истории состояний скрипта
<br><br>

## Запуск скрипта
<br>
В торговом терминале Quik необходимо в меню “Сервисы“ выбрать команду “Lua скрипты”.<br>
В результате появится окно управления всеми скриптами

![](/assets/images/trP/trP_0.PNG)

В данном окне необходимо выполнить команду “Добавить” и выбрать запускаемый файл transactionPocket.lua, сохраненный по месту установки скрипта.<br>
В результате в окне появится дополнительная строка с описанием добавленного файла:


![](/assets/images/trP/trP_1.PNG)


Запуск скрипта осуществляется с помощью команды “Запустить”. При этом запущенный скрипт в окне “Доступные скрипты” будет выделен зеленым треугольником. Остановленный - красным квадратом.<br>
Остановка скрипта осуществляется с помощью команды "Остановить”.
<br><br>

## Главное окно скрипта
<br>
После запуска скрипта будет выведено главное окно скрипта:


![](/assets/images/trP/trP_2.PNG)

Главное окно содержит колонки вывода и управления информацией:

1. **Sec** - код инструмента
2. **Clаss** - класс инструмента
3. **Type** - "Вход" | "Выход" - это служебное поле, необходимое для определения
типа сделки. Если позиция положительная и Dir - продажа, то это
выход. Или, если заявка в "Шорт" и необходимо обеспечить
автоматическое выставление заявки на выход, то надо установить
значение "Вход". По умолчанию для "Лонга" - "Вход". Меняется двойным
кликом по полю.
4. **Dir** - "Покупка" | "Продажа". - Меняется двойным кликом по полю.
5. **Price** - цена выставления заявки.
6. **Qty** - Количество (сумма, процент от счета) в заявке.
7. **qType** - тип количества. Меняется двойным кликом по полю. Возможные значения:
    - «количество лотов» (по умолчанию)
    - «сумма (в рублях)»
    - «% от счета».

    Последние два пункта - это для выставления заявки на сумму, для примера
10000 руб или 2% от счета. Т.е. на этой цене будет взято столько
лотов, чтобы не выйти за эту сумму.
8. **OrdQty** - если заявка по сумме, то здесь будет записано сколько лотов
вышло в заявке. Тогда для автоматической заявки, установленной по
сетке, будет выставлено именно это количество.
9. **Auto** - Меняется двойным кликом по полю. Признак автоматического
выставления заявки в начале торгового дня. Если нет, то такие заявки
ставятся руками через команды.
10. **Cond** - условие выставления заявки в формате «price >= 100.2».
Можно использовать как признак пробоя для входа. Можно как стоп.
Скажем, заявка на продажу при цене ниже 100 («price <= 100»), по цене 97 (чтобы
исполнилась).
11. **sType** - тип шага выставления встречной заявки. Меняется двойным кликом по полю. Возможные значения:
    - «пт» - пункты (по умолчанию). Пункт - это последняя значащая цифра в цене. Т.е. цены 100.02 и 100.03 различаются на 1 пункт.
    - «% от цены.
12.  **NetStep** - шаг выставления встречной заявки (в указанном типе цены) при
исполнении основной.
13.  **AlertPrice** - цена вывода сообщения и отправки сообщения на почту|**Телеграм** при
достижении цены.
1.  **Client** - Код клиента. Меняется двойным кликом по полю.
2.  **Acc** - Номер счета. Меняется двойным кликом по полю.
3.  **Message** - Сообщения для данной строки.
<br><br>

## Правила редактирования полей
<br>
Все редактируемые (числовые, строковые) поля окрашиваются в желтый цвет. Чтобы начать редактировать поле необходимо выделить необходимое поле. Далее можно привычными командами с клавиатуры ввести необходимое значение показателя. При этом, если это необходимо, удалить старое значение. Также числовые поля можно изменять с помощью клавиш “стрелка влево” - уменьшить значение, “стрелка вправо” - увеличить значение. Тем самым можно быстро изменить значение, не вводя его с клавиатуры.
<br><br>

## Работа скрипта
<br>
После запуска скрипт просканирует установленные заявки и уже совершенные сделки до запуска. Они будут выведены в окно скрипта.
Исполненные заявки подсвечиваются розовым цветом. Активные заявки зеленым цветом.


![](/assets/images/trP/trP_3.PNG)


Скрипт поддерживает горячие клавиши:

- 'Снять заявку - Shift+D'
- 'Удалить заявку - Shift+R'
- 'Добавить заявку - Shift+I'
- 'Дублировать заявку - Shift+B'
- 'Активировать заявку - Shift+A'
- 'Установить все заявки - Shift+S'
- 'Снять все заявки - Shift+X’

Чтобы воспользоваться командой для строки, необходимо выделить ее и ввести команду.

Также можно вызвать контекстное меню с данным списком команд, воспользовавшись правой клавишей указателя в строке или заголовке окна.


![](/assets/images/trP/trP_4.PNG)
<br><br>

Чтобы ввести заявку можно просто ввести ее, воспользовавшись возможностями терминала. Заявка будет автоматически добавлена в список и помечена признаком **Auto** для автоматической установки.
Если необходимо ввести заявку вне доступного ценового диапазона, необходимо воспользоваться командой **Добавить заявку - Shift+I**. После ввода команды появится окно выбора инструмента.


![](/assets/images/trP/trP_7.PNG)

В этом окне можно просто выбрать необходимый инструмент либо воспользоваться фильтром. Для этого необходимо просто начать вводить с клавиатуры текст - код инструмента, название инструмента.


![](/assets/images/trP/trP_8.PNG)

После необходимо выбрать искомую строку и она добавится в список.


![](/assets/images/trP/trP_9.PNG)

Далее необходимо указать параметры добавляемой заявки и установить признак **Auto** для ее автоматической установки.

Также необходимо отметить, что при редактировании полей заявки происходит сброс признака **Auto** для предотвращения преждевременной установки заявки. Поэтому после редактирования строки, если это необходимо, надо не забывать установить признак **Auto**.
Если происходит изменение уже установленной заявки, то скрипт автоматически изменит строку, соответствующую ей. Допустим, заявку сместили на графике - это действие просто изменит цену в строке. Если же заявку сняли, то строка будет удалена.

Следует отметить, что снятие активных заявок в торговое время - это удаление строки. Если же заявка была снята в неторговое время (допустим после завершения торговой сессии), то это не приведет к удалению строку. Это необходимо, т.к. после завершения торговой сессии неисполненные заявки удаляются ядром биржи, а нам необходимо, чтобы заявки были восстановлены при следующем старте торгов.

Если необходимо удалить заявку, то, как отмечалось выше, можно удалить ее используя возможности терминала или воспользоваться командой **Удалить заявку - Shift+R'**.
Если необходимо ввести заявку по инструменту, по которому уже есть строка, можно воспользоваться командой **Дублировать заявку - Shift+B**. Это приведет к появлению новой неактивной строки. Отредактировав которую и установив признак **Auto** данная заявка будет установлена.
<br><br>

## Ведение журнала сделок
<br>

Скрипт автоматически ведет журнал всех сделок. В скрипте
доступно второе окно со всеми сделками по инструментам. Двойной
клик по строке покажет подробно сделки конкретного инструмента. Если скрипт запущен постоянно и никогда не останавливается, то будет вестись журнал всех сделок.


![](/assets/images/trP/trP_5.PNG)


![](/assets/images/trP/trP_6.PNG)
<br><br>

## Отправка сообщений
<br>

Скрипт позволяет отправлять оповещения на почту и в **Телеграм**. Для этого используется решение [telegramQuik](https://github.com/nick-nh/qlua/tree/master/telegramQuik).

В папке transactionPocket\libs расположен подкаталог telegramServer. В нем размещены файлы запуска и настройки сервера отправки сообщений.
Скрипт при старте проверяет наличие папки с сервером отправки сообщений и если он найдена, то происходит его запуск, посредством вызова файла startTeleServer.bat, расположенного в каталоге transactionPocket\libs\telegramServer.
После запуска сервера отправки сообщений появится консольное окно, сигнализирующее о его готовности. Одновременный запуск нескольких экземпляров сервера отправки сообщений MessagesQServer.exe нежелателен, т.к. они будут конфликтовать друг с другом.
Поэтому ручной страт сервера желательно производить через файл startTeleServer.bat (скрипт при запуске делает это автоматически).


![](/assets/images/trP/trP_10.PNG)

Перед запуском необходимо провести настройку сервера отправки сообщений. Это производится через редактирование файла settings.ini в каталоге сервера отправки.

Содержимое данного файла:<br>
[TELEGRAM]<br>
START_TELEGRAM = ON<br>
TELEGRAM_PIPENAME = telegram_pipe<br>
TOKEN = Your TOKEN<br>
USE_ENCODING = windows-1251<br>
[EMAIL]<br>
START_EMAIL = ON<br>
EMAIL_PIPENAME = email_pipe<br>
SENDER = sender<br>
RECIPIENT = recipient<br>
COPY =<br>
EMAIL_SUBJECT = Message from Quik<br>
SMTPSERVER = smtp<br>
SERVERPORT = 587<br>
LOGIN = login<br>
PASSWORD = pass<br>

Раздел [TELEGRAM] - раздел настройки отправки сообщений в **Телеграм**. Если необходима отправка сообщений в **Телеграм**, то необходимо установить настройку START_TELEGRAM = ON, иначе OFF. Сообщения в **Телеграм** отправляются в зарегистрированный бот. О регистрации ботов в **Телеграм** можно найти подробную инструкцию на сайте сервиса **Телеграм** или воспользоваться поиском.<br>
- TELEGRAM_PIPENAME - это сервисная настройка имени канала передачи сообщений. Если планируется использовать только один сервер отправки сообщений, то данное поле необходимо оставить без изменения.<br>
- TOKEN - здесь вводится токен, полученный при регистрации бота в **Телеграм**. Если не введен токен, то отправка сообщений в телегам будет невозможна.<br>
- USE_ENCODING = windows-1251. Данная настройка определяет тип кодировки текста сообщений отправляемых из терминала. Т.к. Квик поддерживает только кодировку Win1251, то данную настройку необходимо оставить без изменения.

Раздел [EMAIL] - раздел настройки отправки сообщений на электронную почту. Если необходима отправка почтовых сообщений, то необходимо установить START_EMAIL = ON, иначе OFF.<br>
- EMAIL_PIPENAME - это сервисная настройка имени канала передачи сообщений. Если планируется использовать только один сервер отправки сообщений, то данное поле необходимо оставить без изменения.<br>
- SENDER - электронный адрес отправителя
- RECIPIENT - электронный адрес получателя
- COPY - список (через ;) электронных адресов получателей копии.
- EMAIL_SUBJECT - тема письма
- SMTPSERVER - адрес сервера отправки сообщений. Например smtp.yandex.ru
- SERVERPORT - номер порта отправки сообщений. Обычно это 465. Для сервисов Яндекса также используется 587
- LOGIN - ваш логин
- PASSWORD - ваш пароль
<br><br>

## Служебные настройки скрипта
<br>

Технические параметры задаются в файле transactionPocket_params.ini.
Данный файл содержит следующие настройки:

- Временная зона (0, 1, -1, -2...). Скрипт работает по времени биржи, поэтому для исключения ошибок определения времени необходимо указать свою временную зону.<br>
--положительные значения вводятся без знака, отрицательные с знаком<br>
TIME_ZONE                     = 0

- Классы инструментов для возможности выбора из формы выбора и отслеживания<br>
TRACK_CLASS_CODES             = 'TQOD|TQOB|TQTD|TQTF|EQEO|EQOB|EQDB|SPBBND|SPBXM|RPSPBXM|SPBDE|QJSIM|TQBR|FQBR|SPBFUT'

- Максимальное число транзакций в секунду<br>
MAX_ORDERS_PER_SECOND         = 50

- Максимальное время ожидания ответа транзакции (сек.)<br>
TRANS_RESPONSE_MAX_TIME       = 600

- Интервал обновления данных с текущим состоянием c сервера брокера (сек.)<br>
Задается в настройках терминала в пункте меню «Система» / «Настройки» / «Основные настройки» / «Программа» на вкладке «Получение данных»<br>
Для непрерывного получения данных с сервера в настройках терминала не должен быть устновлен период опроса данных (пометка снята).<br>
Если время сервера больше времени последнего сообщения чем период опроса, то связь с сервером брокера еще не установлена или есть проблемы с связью.<br>
Терминал получет данных с сервера пакетами. У каждого пакета есть время.<br>
Если время пакета меньше чем время сервера больше чем указанное значение этого параметра (в сек.), то считаем, что еще идет процесс загрузки данныя, скрипт перейдет в режим ожидания.<br>
Для неустойчивой связи можно попробовать увеличить этот параметр, чтобы считать связь установленной, даже если есть задержка пакета.<br>
-- По умолчанию 1<br>
-- Для отключения проверки необходимо установить значение: -1<br>
SERVER_DATA_CYCLE_TIME       = -1

- Допустимое расхождение (в сек.) времени сервера и локального времени рабочего места
если -1, то не контролируется<br>
MAX_LOCAL_TO_SERVER_TIME_DIFF = -1

- Отправлять email<br>
-- 1 - да<br>
-- 0 - нет<br>
SEND_EMAIL                    = 1

- Отправлять сообщение в Телеграм<br>
-- 1 - да<br>
-- 0 - нет<br>
SEND_TELEGRAM                 = 0

- Имя канала отправки сообщений в телеграм, email.<br>
-- Такое же имя должно быть установлено в настройках сервера отправки.<br>
    - EMAIL_PIPE                    = 'email_pipe'
    - TELEGRAM_PIPE                 = 'telegram_pipe'

- Служебные параметры<br>
    - LOGGING                 = 1 -- признак ведения лога. 1 - выводить, 0 - нет
    - DEBUG_MODE              = 1 -- признак вывода отладочных сообщений в лог файлы

- Настройка закрытия основного окна робота: 1 - при закрытии окна робота выключать скрипт, 0 - переоткрывать окно<br>
STOP_ON_CLOSE_TABLE           = 1

- str_autoSetOrdersTime         = '09:50:00' -- Время начала установки ордеров.

- Технологические времена работы биржи<br>
    - str_startNewDayTime           = '09:30:00' -- Время начала нового дня (на данный момент нет утренней сессии, поэтому время начала дня лучше установить в 9:30 т.к. примерно в это время сервера брокеров начинают транслировать корректные данные)
    - str_morningStartTradeTime     = '07:00:00' -- Начало утренней сессии
    - str_morningEndTradeTime       = '08:40:00' -- Окончание утренней сессии
    - str_morningAuctionTime        = '09:50:00' -- Время утреннего аукциона
    - str_startTradeTime            = '10:00:00' -- Начало основной сессии
    - str_dayClearing               = '14:00:00' -- Начало дневного клиринга
    - str_endOfDayClearing          = '14:05:00' -- Окончание дневного клиринга
    - str_endTradeTime              = '18:40:00' -- Окончание дневной сессии (для фондовой секции)
    - str_eveningClearing           = '18:45:00' -- Время начала основного клиринга. Для проверки возможного сброса заявок
    - str_shareEndOfDay             = '18:50:00' -- Окончание торговли (для фондовой секции)
    - str_eveningSession            = '19:00:00' -- Время окончания клиринга. Для проверки возможного сброса заявок
    - str_endOfDay                  = '23:50:00' -- Окончание торгового дня
